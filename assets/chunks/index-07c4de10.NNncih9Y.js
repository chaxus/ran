import{S as J,a as S,e as K,t as w,b as Q}from"./index.lgZ6PAGs.js";import{g as V,a as Z}from"./colz-746223ab.65el2PIW.js";import"./framework.Nn4nSjKp.js";var tt=Object.defineProperty,et=(t,r,e)=>r in t?tt(t,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[r]=e,d=(t,r,e)=>(et(t,typeof r!="symbol"?r+"":r,e),e);const A=["#FFFFFF","#000000","#BFBFBF","#323232","#4472C4","#ED7D31","#A5A5A5","#FFC000","#5B9BD5","#71AD47"],P=["#000000","#FFFFFF","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#000000","#FFFFFF","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#800000","#008000","#000080","#808000","#800080","#008080","#C0C0C0","#808080","#9999FF","#993366","#FFFFCC","#CCFFFF","#660066","#FF8080","#0066CC","#CCCCFF","#000080","#FF00FF","#FFFF00","#00FFFF","#800080","#800000","#008080","#0000FF","#00CCFF","#CCFFFF","#CCFFCC","#FFFF99","#99CCFF","#FF99CC","#CC99FF","#FFCC99","#3366FF","#33CCCC","#99CC00","#FFCC00","#FF9900","#FF6600","#666699","#969696","#003366","#339966","#003300","#333300","#993300","#993366","#333399","#333333","#FFFFFF"],rt=80,st=24;function ot(t){try{return new K.Workbook().xlsx.load(t)}catch(r){return console.warn(r),Promise.reject(r)}}function it(t,r,e){for(let i=0;i<(t.columns||[]).length;i++)r.cols[i.toString()]={},t.columns[i].width?r.cols[i.toString()].width=t.columns[i].width*6+(e.widthOffset||0):r.cols[i.toString()].width=rt+(e.widthOffset||0);r.cols.len=Math.max(Object.keys(r.cols).length,e.minColLength||0)}function nt(t){const{numFmt:r,value:e,type:i}=t;switch(i){case 2:try{if(t.style.numFmt){if(t.style.numFmt.endsWith("%")){const s=t.style.numFmt.match(/\.(\d+)%/);return s?(Number(e)*100).toFixed(s[1].length)+"%":Number(e)*100+"%"}else if(/0(?:\.0+)?/.test(t.style.numFmt)){if(Number(e)===0&&t.style.numFmt.startsWith("_"))return"-";let s=t.style.numFmt.match(/0\.(0+)(_|;|$)/);s?s=s[1].length:s=0;let n=Number(e).toFixed(s)+"";if(t.style.numFmt.includes("#,##")){n=n.split(".");const o=n[0].split("").reverse(),a=[];for(let l=0;l<o.length;l++)a.push(o[l]),(l+1)%3===0&&l<o.length-1&&o[l+1]!=="-"&&a.push(",");n[0]=a.reverse().join(""),n=n.join(".")}return n}}return e+""}catch{return e}case 3:return e;case 4:switch(r){case"mm-dd-yy":return w(e).format("YYYY/MM/DD");case"[$-F800]dddd, mmmm dd, yyyy":return w(e).format("YYYY年M月D日 ddd");case'm"月"d"日";@':return w(e).format("M月D日");case"yyyy/m/d h:mm;@":case'm/d/yy "h":mm':return w(e).subtract(8,"hour").format("YYYY/M/DD HH:mm");case"h:mm;@":return w(e).format("HH:mm");default:return w(e).format("YYYY-MM-DD")}case 5:return e.text;case 6:return S.get(e,"result.error")||e.result;case 8:return t.text;default:return e}}function R(t){if(typeof t=="object")return"#000000";if(/^#?[a-f\d]{6}$/i.test(t))return t.startsWith("#")?t:"#"+t;t=t.trim().toLowerCase();const r={};try{const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t)||"";return r.r=parseInt(e[2],16),r.g=parseInt(e[3],16),r.b=parseInt(e[4],16),r.a=parseInt(e[1],16)/255,Q(`rgba(${r.r}, ${r.g}, ${r.b}, ${r.a})`).toHexString()}catch(e){console.warn(e)}}function j(t,r){return t>9?"#C7C9CC":typeof r>"u"?A[t]:r>0?V(A[t],r):Z(A[t],Math.abs(r))}function at(t){t.style=S.cloneDeep(t.style);let r=null;t.style.fill&&t.style.fill.fgColor&&(t.style.fill.fgColor.argb?r=R(t.style.fill.fgColor.argb):Object.prototype.hasOwnProperty.call(t.style.fill.fgColor,"theme")?r=j(t.style.fill.fgColor.theme,t.style.fill.fgColor.tint):t.style.fill.fgColor.indexed?r=P[t.style.fill.fgColor.indexed]||"#C7C9CC":r="#C7C9CC"),r&&(t.style.bgcolor=r);let e=null;if(t.style.font&&t.style.font.color&&(t.style.font.color.argb?e=R(t.style.font.color.argb):Object.prototype.hasOwnProperty.call(t.style.font.color,"theme")?e=j(t.style.font.color.theme,t.style.font.color.tint):t.style.font.color.indexed?e=P[t.style.font.color.indexed]||"#000000":e="#000000"),e&&(t.style.color=e),t.style.alignment&&(t.style.alignment.horizontal&&(t.style.align=t.style.alignment.horizontal),t.style.alignment.vertical&&(t.style.valign=t.style.alignment.vertical)),t.style.alignment&&t.style.alignment.wrapText&&(t.style.textwrap=!0),t.style.border){const i={};Object.keys(t.style.border).forEach(s=>{const n=t.style.border[s];let o="#000000";typeof n.color=="string"?o=n.color:n.color&&(n.color.argb?o=R(n.color.argb)||"":Object.prototype.hasOwnProperty.call(n.color,"theme")?o=j(n.color.theme,n.color.tint):n.color.indexed&&(o=P[n.color.indexed])),i[s]=[n.style||"thin",o]}),t.style.border2={...t.style.border},t.style.border=i}return t.style}function lt(t,r){const e=[];return t.eachSheet(i=>{const s={name:i.name,styles:[],rows:{},cols:{},merges:[],media:[]},n=[];for(const o in i._merges){s.merges.push(i._merges[o].shortRange);const a={};a.startAddress=i._merges[o].tl,a.endAddress=i._merges[o].br,a.YRange=i._merges[o].model.bottom-i._merges[o].model.top,a.XRange=i._merges[o].model.right-i._merges[o].model.left,n.push(a)}it(i,s,r),(i._rows||[]).forEach((o,a)=>{s.rows[a]={cells:{}},o.height?s.rows[a].height=o.height+(r.heightOffset||0):s.rows[a].height=st+(r.heightOffset||0),(o._cells||[]).forEach((l,f)=>{s.rows[a].cells[f]={};const c=S.find(n,function(F){return F.startAddress===l._address});c&&l.master.address!==c.startAddress||(c&&(s.rows[a].cells[f].merge=[c.YRange,c.XRange]),s.rows[a].cells[f].text=nt(l),s.styles.push(at(l)),s.rows[a].cells[f].style=s.styles.length-1)})}),s._media&&(s.media=s._media),s.rows.len=Math.max(Object.keys(s.rows).length,100),e.push(s)}),{workbookData:e,workbookSource:t,medias:t.media||[]}}let D=[];function _(t,r,e,i){e&&e._media.length&&e._media.forEach(s=>{const{imageId:n,range:o,type:a}=s;if(a==="image"){const l=ht(e,o,i);ft(t,n,r[n],l)}})}const k=60,O=25,W=80,M=24,m=window.devicePixelRatio;function ht(t,r,e){var i,s,n,o,a,l,f,c,F,g,y,b,u,H;const{tl:q={},br:z={}}=r,{nativeCol:v,nativeColOff:Y,nativeRow:x,nativeRowOff:E}=q;let $=k,B=O;for(let h=0;h<v;h++)$+=((s=(i=t==null?void 0:t._columns)==null?void 0:i[h])==null?void 0:s.width)*6||W;for(let h=0;h<x;h++)B+=((o=(n=t==null?void 0:t._rows)==null?void 0:n[h])==null?void 0:o.height)||M;const U=$+Y/12700,G=B+E/12700,{nativeCol:T,nativeColOff:I,nativeRow:L,nativeRowOff:N}=z;let p;if(v===T)p=(I-Y)/12700;else{p=(((l=(a=t==null?void 0:t._columns)==null?void 0:a[v])==null?void 0:l.width)*6||W)-Y/12700;for(let h=v+1;h<T;h++)p+=((c=(f=t==null?void 0:t._columns)==null?void 0:f[h])==null?void 0:c.width)*6||W;p+=I/12700}let C;if(x===L)C=(N-E)/12700;else{C=(((g=(F=t==null?void 0:t._rows)==null?void 0:F[x])==null?void 0:g.height)||M)-E/12700;for(let h=x+1;h<L;h++)C+=((b=(y=t==null?void 0:t._rows)==null?void 0:y[h])==null?void 0:b.height)||M;C+=N/12700}return{x:(U-(((u=e==null?void 0:e.scroll)==null?void 0:u.x)||0))*m,y:(G-(((H=e==null?void 0:e.scroll)==null?void 0:H.y)||0))*m,width:p*m,height:C*m}}function X(){D=[]}function ft(t,r,e,i){ct(r,e).then(s=>{let n=0,o=0,a=s.width,l=s.height,f=i.x,c=i.y,F=i.width,g=i.height;const y=F/a,b=g/l;if(f<k*m){const u=k*m-f;f=k*m,F-=u,a-=u/y,n+=u/y}if(c<O*m){const u=O*m-c;c=O*m,g-=u,l-=u/b,o+=u/b}t.drawImage(s,n,o,a,l,f,c,F,g)}).catch(s=>{})}function ct(t,r){return new Promise((e,i)=>{if(D[t])return e(D[t]);const{buffer:s,extension:n}=r.buffer,o=new Blob([s],{type:"image/"+n}),a=URL.createObjectURL(o),l=new Image;l.src=a,l.onload=function(){e(l),D[t]=l},l.onerror=function(f){i(f)}})}function dt(t){if(t){const r=t.querySelectorAll("input");for(const e of r)e&&!e.readOnly&&(e.readOnly=!0)}}const ut={minColLength:20};class mt{constructor(r,e={}){d(this,"container"),d(this,"options",{}),d(this,"wrapper"),d(this,"wrapperMain"),d(this,"xs"),d(this,"sheetIndex"),d(this,"mediasSource"),d(this,"workbookDataSource"),d(this,"ctx"),d(this,"fileData"),d(this,"observer"),d(this,"offset"),this.container=r,this.options={...ut,...e},this.sheetIndex=1,this.mediasSource={},this.workbookDataSource={_worksheets:[]},this.createWrapper(),this.initSpreadsheet(),this.hack()}createWrapper(){this.wrapper=document.createElement("div"),this.wrapper.className="r-preview-excel-main",this.container.appendChild(this.wrapper)}initSpreadsheet(){var r;if(!this.wrapper||(this.xs=new J(this.wrapper,{mode:"read",showToolbar:!1,showContextmenu:this.options.showContextmenu||!1,view:{height:()=>this.wrapper&&this.wrapper.clientHeight||300,width:()=>this.wrapper&&this.wrapper.clientWidth||1200},row:{height:24,len:100},col:{len:26,width:80,indexWidth:60,minWidth:60}}).loadData({}),!this.xs))return;if(this.xs.bottombar){const i=this.xs.bottombar.swapFunc;this.xs.bottombar.swapFunc=s=>{var n;i.call((n=this.xs)==null?void 0:n.bottombar,s),this.sheetIndex=s+1,setTimeout(()=>{var o,a;(o=this.xs)!=null&&o.reRender&&((a=this.xs)==null||a.reRender()),this.mediasSource&&this.ctx&&this.offset&&_(this.ctx,this.mediasSource,this.workbookDataSource._worksheets[this.sheetIndex],this.offset)})}}if((r=this.xs.sheet)!=null&&r.editor){const i=this.xs.sheet.editor.clear;this.xs.sheet.editor.clear=(...n)=>{var o,a;i.apply((a=(o=this.xs)==null?void 0:o.sheet)==null?void 0:a.editor,n),setTimeout(()=>{this.ctx&&this.mediasSource&&this.offset&&_(this.ctx,this.mediasSource,this.workbookDataSource._worksheets[this.sheetIndex],this.offset)})};const s=this.xs.sheet.editor.setOffset;this.xs.sheet.editor.setOffset=(...n)=>{var o,a;s.apply((a=(o=this.xs)==null?void 0:o.sheet)==null?void 0:a.editor,n),n.length>1&&(this.offset=n.shift()),this.ctx&&this.mediasSource&&this.offset&&_(this.ctx,this.mediasSource,this.workbookDataSource._worksheets[this.sheetIndex],this.offset)}}const e=this.wrapper.querySelector("canvas");e&&(this.ctx=e.getContext("2d"))}renderExcel(r){return this.fileData=r,ot(r).then(e=>{var i;if(!e._worksheets||e._worksheets.length===0)throw new Error("未获取到数据，可能文件格式不正确或文件已损坏");const{workbookData:s,medias:n,workbookSource:o}=lt(e,this.options);this.mediasSource=n,this.workbookDataSource=o,this.offset=void 0,this.sheetIndex=1,X(),(i=this.xs)==null||i.loadData(s),this.ctx&&this.mediasSource&&this.offset&&_(this.ctx,this.mediasSource,this.workbookDataSource._worksheets[this.sheetIndex],this.offset)}).catch(e=>{var i;return this.mediasSource=[],this.workbookDataSource={_worksheets:[]},X(),(i=this.xs)==null||i.loadData({}),Promise.reject(e)})}hack(){if(!this.wrapper)return;const r=S.debounce(dt,200).bind(this,this.wrapper);this.observer=new MutationObserver(r);const e={attributes:!0,childList:!0,subtree:!0};this.observer.observe(this.wrapper,e),r()}}const yt=(t,r)=>{if(!r)return Promise.reject();const e=new mt(r);return new Promise((s,n)=>{const o=new FileReader;o.readAsArrayBuffer(t),o.onload=()=>{o.result?s(o==null?void 0:o.result):n()}}).then(s=>{e.renderExcel(s)})};export{yt as renderExcel};
